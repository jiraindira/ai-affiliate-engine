---
import SiteLayout from "../../layouts/SiteLayout.astro";
import PreviousPostTile from "../../components/PreviousPostTile.astro";
import { getCollection } from "astro:content";
import { getTaxonomy } from "../../lib/taxonomy";
import { normalizePostCategories } from "../../lib/normalizeCategories";
import {
  buildBreadcrumbList,
  buildCollectionPageJsonLd,
  toAbsoluteUrl,
} from "../../lib/structuredData";

export async function getStaticPaths() {
  const taxonomy = await getTaxonomy();

  // Build routes from taxonomy groups (plus "all")
  const paths = [
    { params: { group: "all" } },
    ...taxonomy.groups.map((g) => ({ params: { group: g.key } })),
  ];

  // De-dupe group keys
  const seen = new Set<string>();
  return paths.filter((p) => {
    const k = String(p.params.group || "").trim().toLowerCase();
    if (!k || seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

const taxonomy = await getTaxonomy();
const { group } = Astro.params;

const groupKey = String(group || "").trim().toLowerCase();

// Find group (except "all")
const grp =
  groupKey === "all"
    ? { key: "all", label: "All", intro: "", categoryIds: [] as string[] }
    : taxonomy.groups.find((g) => String(g.key || "").trim().toLowerCase() === groupKey);

const label = grp?.label ?? "All";
const intro = grp?.intro ?? "";

// âœ… taxonomy.json uses groups[].categoryIds
const groupCats =
  groupKey === "all"
    ? null
    : (grp?.categoryIds ?? (grp as any)?.categories ?? [])
        .map((c) => String(c || "").trim().toLowerCase())
        .filter(Boolean);

const posts = await getCollection("posts");
posts.sort((a, b) => {
  const t = b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
  if (t !== 0) return t;
  return b.slug.localeCompare(a.slug);
});

// Include if ANY category matches
const filtered =
  groupKey === "all"
    ? posts
    : posts.filter((post) => {
        const postCats = normalizePostCategories(post, taxonomy);
        return postCats.some((c) => (groupCats ?? []).includes(c));
      });

const pageTitle = `${label} guides`;
const pageDesc = intro || `Latest curated buying guides in ${label}.`;

const baseUrl = (Astro.site ?? "http://localhost").toString();
const canonicalPath = `/posts/${groupKey}`;
const canonicalUrl = toAbsoluteUrl(baseUrl, canonicalPath);

const breadcrumbJsonLd = buildBreadcrumbList([
  { name: taxonomy.brand.name, url: toAbsoluteUrl(baseUrl, "/") },
  { name: "Guides", url: toAbsoluteUrl(baseUrl, "/posts") },
  { name: label, url: canonicalUrl },
]);

const listJsonLd = buildCollectionPageJsonLd({
  canonicalUrl,
  name: pageTitle,
  description: pageDesc,
  itemList: filtered.map((p) => ({
    name: String(p.data.title),
    url: toAbsoluteUrl(baseUrl, `/posts/${p.slug}`),
  })),
});
---

<SiteLayout title={pageTitle} description={pageDesc} canonical={`/posts/${groupKey}`}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(listJsonLd)} />
  </Fragment>

  <div class="max-w-6xl mx-auto px-6 pt-12">
    <div class="flex items-end justify-between gap-6">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight text-gray-900">{label}</h1>
        {pageDesc ? <p class="mt-2 text-sm text-gray-600">{pageDesc}</p> : null}
      </div>

      <a href="/posts" class="text-sm font-semibold text-blue-700 hover:text-blue-800">
        View all
      </a>
    </div>

    <hr class="mt-6 border-t-2 border-gray-900/25" />

    {filtered.length ? (
      <div class="mt-10 grid grid-cols-2 gap-3 sm:gap-4">
        {filtered.map((post) => (
          <PreviousPostTile post={post} />
        ))}
      </div>
    ) : (
      <div class="mt-10 rounded-2xl border border-dashed border-gray-300 bg-white p-10">
        <p class="text-sm text-gray-600">No guides in this section yet.</p>
      </div>
    )}
  </div>
</SiteLayout>