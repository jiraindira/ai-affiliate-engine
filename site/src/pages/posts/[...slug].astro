---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import PostLayout from "../../layouts/PostLayout.astro";
import ProductListItem from "../../components/ProductListItem.astro";
import { getPostHeroImage } from "../../lib/postImages";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const { products = [], category, publishedAt } = post.data;

const FALLBACK_HERO = "/images/placeholder-hero.webp";

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

function prettyCategory(s) {
  if (!s) return "";
  return s
    .replace(/_/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase())
    .replace(/\bAnd\b/g, "&");
}

function slugifyHeading(text) {
  return String(text || "")
    .toLowerCase()
    .trim()
    .replace(/[’']/g, "")
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
}

function estimateReadingTimeFromMarkdown(md) {
  const text = String(md || "")
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/`[^`]*`/g, " ")
    .replace(/[#>*_~]/g, " ");
  const words = text.trim().split(/\s+/).filter(Boolean).length;
  const mins = Math.max(1, Math.round(words / 220));
  return mins;
}

function extractTocFromMarkdown(md) {
  const lines = String(md || "").split("\n");
  const toc = [];
  for (const line of lines) {
    const m = line.match(/^##\s+(.+)\s*$/);
    if (!m) continue;
    const text = m[1].trim();
    // Skip obvious non-content headings if you want:
    // if (text.toLowerCase() === "top picks") continue;
    const id = slugifyHeading(text);
    toc.push({ text, id });
  }
  return toc;
}

const dateLabel = publishedAt ? formatDate(publishedAt) : "";
const categoryLabel = category ? prettyCategory(category) : "";

const picks = products;

// Normalize hero image value
const heroImageRaw =
  typeof post?.data?.heroImage === "string" && post.data.heroImage.trim().length > 0
    ? post.data.heroImage.trim()
    : FALLBACK_HERO;

const heroAlt =
  typeof post?.data?.heroAlt === "string" && post.data.heroAlt.trim().length > 0
    ? post.data.heroAlt.trim()
    : post?.data?.title ?? "";

const isPublicHero = heroImageRaw.startsWith("/");
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

// SEO / sharing
const canonical = `/posts/${post.slug}`;
const ogImage = heroImageRaw;

// Build TOC + reading time from raw markdown body (available on content entries)
const rawBody = post.body ?? "";
const toc = extractTocFromMarkdown(rawBody);
const readingTime = estimateReadingTimeFromMarkdown(rawBody);

// We also need to ensure headings in rendered markdown have matching ids.
// Astro/markdown usually generates ids, but to be safe we add a small CSS offset target handling
// and we anchor our pick section manually.
---

<SiteLayout
  title={post.data.title}
  description={post.data.description}
  canonical={canonical}
  ogImage={ogImage}
>
  <PostLayout
    title={post.data.title}
    description={post.data.description}
    publishedAt={publishedAt}
    category={category}
    audience={post.data.audience}
    heroImage={heroImageRaw}
    heroAlt={heroAlt}
    imageCreditName={post.data.imageCreditName}
    imageCreditUrl={post.data.imageCreditUrl}
    readingTime={readingTime}
    toc={toc}
  >
    <Content />

    <hr />

    <section id="top-picks" class="picks-block">
      <h2>Top picks</h2>
      <p class="picks-sub">
        A practical short-list with direct links.
      </p>

      <div class="picks-list">
        {picks.map((p, idx) => (
          <div id={`pick-${idx + 1}`} class="pick-anchor">
            <ProductListItem product={p} index={idx + 1} />
          </div>
        ))}
      </div>
    </section>

    <Fragment slot="sidebar">
      <div class="side-stack">
        <div class="sidecard-lite">
          <div class="side-title">Quick picks</div>
          <ol class="quick-list">
            {picks.map((p, idx) => (
              <li class="quick-item">
                <a href={`#pick-${idx + 1}`} class="quick-link">
                  <span class="quick-num">{idx + 1}.</span> {p.title}
                </a>
                <div class="quick-meta">
                  {typeof p.rating === "number" ? (
                    <span>{p.rating.toFixed(1)}★</span>
                  ) : null}
                  {typeof p.reviews_count === "number" ? (
                    <span>
                      {typeof p.rating === "number" ? " · " : ""}
                      {p.reviews_count.toLocaleString()} reviews
                    </span>
                  ) : null}
                </div>
              </li>
            ))}
          </ol>

          <a href="#top-picks" class="jump-link">Jump to list →</a>
        </div>
      </div>
    </Fragment>

    <style>
      .picks-block {
        margin-top: 28px;
      }
      .picks-sub {
        margin-top: 8px;
        color: rgba(55, 65, 81, 0.85);
        font-size: 14px;
        line-height: 1.55;
      }
      .picks-list {
        margin-top: 18px;
        display: grid;
        gap: 18px;
      }
      .pick-anchor {
        scroll-margin-top: 90px;
      }

      .side-stack {
        display: grid;
        gap: 12px;
      }
      .sidecard-lite {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(17, 24, 39, 0.08);
        border-radius: 18px;
        padding: 16px;
      }
      .side-title {
        font-size: 13px;
        font-weight: 750;
        color: rgba(17, 24, 39, 0.9);
      }
      .quick-list {
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 10px;
        font-size: 13px;
      }
      .quick-link {
        text-decoration: none;
        color: rgba(17, 24, 39, 0.86);
        font-weight: 650;
        line-height: 1.25;
      }
      .quick-link:hover {
        color: rgb(37, 99, 235);
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .quick-num {
        color: rgba(55, 65, 81, 0.65);
        font-weight: 700;
        margin-right: 4px;
      }
      .quick-meta {
        margin-top: 4px;
        color: rgba(55, 65, 81, 0.7);
        font-size: 12px;
      }
      .jump-link {
        display: inline-block;
        margin-top: 12px;
        font-size: 13px;
        font-weight: 650;
        color: rgb(37, 99, 235);
        text-decoration: none;
      }
      .jump-link:hover {
        text-decoration: underline;
        text-underline-offset: 3px;
      }
    </style>
  </PostLayout>
</SiteLayout>
